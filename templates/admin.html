<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Wedding Reservation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Great+Vibes&display=swap"
        rel="stylesheet">
</head>

<body>

    <div class="container">
        <header>
            <h1>Admin Dashboard</h1>
        </header>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert-message">
            {% for message in messages %}
            {{ message }}
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% if login %}
        <div class="login-card">
            <h2>Login</h2>
            <form method="POST">
                <label>Username</label>
                <input type="text" name="username" required>
                <label>Password</label>
                <input type="password" name="password" required>
                <button type="submit" class="btn btn-full mt-1">Login</button>
            </form>
        </div>
        {% else %}
        <div class="admin-header">
            <h2 class="font-holiday">Pending Reservations <span class="badge">{{ reservations|length }}</span></h2>
            <button onclick="handleLogout()" class="btn btn-small">Logout</button>
        </div>

        {% if reservations %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Seat</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Dietary</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in reservations %}
                    <tr id="row-{{ r.id }}">
                        <td>#{{ r.display_seat_number }}</td>
                        <td>{{ r.first_name }} {{ r.surname }}</td>
                        <td>
                            {{ r.phone }}<br>
                            {{ r.email }}
                        </td>
                        <td>{{ r.dietary_restrictions }}</td>
                        <td>
                            <button onclick="handleAction('{{ r.id }}', 'accept')"
                                class="btn btn-small btn-approve">Accept</button>
                            <button onclick="handleAction('{{ r.id }}', 'decline')"
                                class="btn btn-small btn-decline">Decline</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No pending reservations.</p>
        {% endif %}

        <hr class="admin-divider">

        <h3 class="font-holiday">Confirmed Guests <span class="badge">{{ confirmed|length }}</span></h3>
        {% if confirmed %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Seat</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Dietary</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in confirmed %}
                    <tr>
                        <td>#{{ r.display_seat_number }}</td>
                        <td>{{ r.first_name }} {{ r.surname }}</td>
                        <td>{{ r.phone }}<br>{{ r.email }}</td>
                        <td>{{ r.dietary_restrictions }}</td>
                        <td>
                            {% if not r.email_sent %}
                            <button onclick="handleAction('{{ r.id }}', 'send_email')" class="btn btn-small"
                                style="font-size: 0.8rem; padding: 0.3rem 0.8rem; background-color: var(--accent-color);">Send
                                Email</button>
                            <button onclick="handleAction('{{ r.id }}', 'decline')" class="btn btn-small btn-decline"
                                style="font-size: 0.8rem; padding: 0.3rem 0.8rem;">Undo (Decline)</button>
                            {% else %}
                            <span class="badge"
                                style="background-color: var(--reserved-color); color: white; font-size: 0.8rem;">Email
                                Sent</span>
                            <button onclick="handleAction('{{ r.id }}', 'send_email')" class="btn btn-small"
                                style="font-size: 0.7rem; padding: 0.2rem 0.6rem; background-color: #7f8c8d;">Resend</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No confirmed guests yet.</p>
        {% endif %}

        <h3 class="font-holiday" style="margin-top: 3rem;">Declined Reservations <span class="badge badge-secondary">{{
                declined|length }}</span></h3>
        {% if declined %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Original Seat</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in declined %}
                    <tr>
                        <td>#{{ r.display_seat_number }}</td>
                        <td>{{ r.first_name }} {{ r.surname }}</td>
                        <td>{{ r.phone }}<br>{{ r.email }}</td>
                        <td>Declined</td>
                        <td>
                            {% if not r.email_sent %}
                            <button onclick="handleAction('{{ r.id }}', 'send_email')" class="btn btn-small"
                                style="font-size: 0.8rem; padding: 0.3rem 0.8rem; background-color: var(--accent-color);">Send
                                Email</button>
                            <button onclick="handleAction('{{ r.id }}', 'accept')" class="btn btn-small btn-approve"
                                style="font-size: 0.8rem; padding: 0.3rem 0.8rem;">Undo (Accept)</button>
                            {% else %}
                            <span class="badge"
                                style="background-color: var(--reserved-color); color: white; font-size: 0.8rem;">Email
                                Sent</span>
                            <button onclick="handleAction('{{ r.id }}', 'send_email')" class="btn btn-small"
                                style="font-size: 0.7rem; padding: 0.2rem 0.6rem; background-color: #7f8c8d;">Resend</button>
                            <button onclick="handleAction('{{ r.id }}', 'accept')" class="btn btn-small btn-approve"
                                style="font-size: 0.8rem; padding: 0.3rem 0.8rem;">Undo (Accept)</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No declined reservations.</p>
        {% endif %}

        {% endif %}
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="text-align: center; padding: 3rem;">
            <h2 class="font-holiday" style="color: var(--text-color); margin-bottom: 1rem;">Confirm Action</h2>
            <p id="confirmMessage" style="font-size: 1.2rem; margin-bottom: 2rem;">Are you sure?</p>
            <div style="display: flex; justify-content: center; gap: 1rem;">
                <button class="btn btn-small" onclick="closeConfirmation(false)"
                    style="background-color: transparent; border-color: var(--text-color); color: var(--text-color);">Cancel</button>
                <button class="btn btn-small" onclick="confirmActionCallback()"
                    style="background-color: var(--accent-color);">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content" style="text-align: center; padding: 3rem;">
            <h2 id="notifTitle" class="font-holiday" style="color: var(--accent-color); margin-bottom: 1rem;">Success
            </h2>
            <p id="notifMessage" style="font-size: 1.2rem; margin-bottom: 2rem;">Message goes here.</p>
            <button class="btn" onclick="closeNotification()">OK</button>
        </div>
    </div>

    <script>
        const notifModal = document.getElementById("notificationModal");
        const confirmModal = document.getElementById("confirmationModal");
        let redirectOnClose = null;
        let pendingAction = null; // Store the function to run if confirmed

        function showNotification(title, message, isSuccess, redirectUrl = null) {
            document.getElementById("notifTitle").innerText = title;
            document.getElementById("notifTitle").style.color = isSuccess ? "var(--accent-color)" : "#c0392b";
            document.getElementById("notifMessage").innerText = message;
            notifModal.style.display = "flex";
            redirectOnClose = redirectUrl;
        }

        function closeNotification() {
            notifModal.style.display = "none";
            if (redirectOnClose) {
                window.location.href = redirectOnClose;
            }
        }

        function showConfirmation(message, callback) {
            document.getElementById("confirmMessage").innerText = message;
            pendingAction = callback;
            confirmModal.style.display = "flex";
        }

        function closeConfirmation(confirmed) {
            confirmModal.style.display = "none";
            if (!confirmed) {
                pendingAction = null;
            }
        }

        function confirmActionCallback() {
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
            closeConfirmation(true);
        }

        function handleLogout() {
            showNotification('Goodbye', 'You have been logged out successfully.', true, "{{ url_for('logout') }}");
        }

        function handleAction(id, action) {
            let confirmMsg = 'Are you sure you want to ' + action + ' this reservation?';
            if (action === 'send_email') {
                confirmMsg = 'Send email notification to this guest? This cannot be undone.';
            } else if (action === 'accept') {
                confirmMsg = 'Are you sure you want to Accept this reservation?';
            } else if (action === 'decline') {
                confirmMsg = 'Are you sure you want to Decline this reservation?';
            }

            // Show custom confirmation modal instead of native confirm
            showConfirmation(confirmMsg, async () => {
                try {
                    const response = await fetch('/admin/action/' + id + '/' + action);
                    const result = await response.json();

                    if (result.success) {
                        showNotification('Success', result.message, true, location.href);
                    } else {
                        showNotification('Error', result.message, false);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Error', 'Action failed.', false);
                }
            });
        }
    </script>

</body>

</html>